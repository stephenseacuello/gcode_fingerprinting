# W&B Overnight Sweep for 4-digit vocabulary - 2024-11-30
# Comprehensive hyperparameter search for best operation accuracy

project: gcode-fingerprinting-4
entity: seacuello-university-of-rhode-island
name: 4digit-overnight-sweep

program: scripts/train_multihead.py
method: bayes
metric:
  name: val/operation_acc
  goal: maximize

run_cap: 120

command:
  - ${env}
  - PYTHONPATH=src
  - PYTORCH_ENABLE_MPS_FALLBACK=1
  - .venv/bin/python
  - ${program}
  - --use-wandb
  - --wandb-project
  - gcode-fingerprinting-4
  - --track-metric
  - operation_acc
  - --data-dir
  - outputs/processed_4digit_hybrid
  - --vocab-path
  - data/vocabulary_4digit_hybrid.json
  - --class-weights-path
  - outputs/class_weights_4digit.json
  - --output-dir
  - outputs/sweep_overnight_4digit
  - ${args}

early_terminate:
  type: hyperband
  min_iter: 20
  s: 2

parameters:
  # Training duration
  max_epochs:
    value: 150

  patience:
    value: 25

  # Architecture - focused range based on best results
  hidden_dim:
    values: [256, 320, 384]

  num_heads:
    values: [4, 8]

  num_layers:
    values: [5, 6, 7]

  dropout:
    distribution: uniform
    min: 0.18
    max: 0.32

  # Training
  batch_size:
    values: [32, 48]

  learning_rate:
    distribution: log_uniform_values
    min: 2e-5
    max: 8e-5

  weight_decay:
    distribution: log_uniform_values
    min: 0.01
    max: 0.08

  grad_clip:
    values: [0.5, 1.0]

  # Loss weights (operation-focused)
  command_weight:
    value: 0.0

  operation_weight:
    values: [5.0, 10.0, 15.0]

  param_type_weight:
    values: [1.0, 2.0]

  param_value_weight:
    values: [3.0, 5.0]

  grammar_weight:
    value: 0.1

  # Focal loss
  use_focal_loss:
    value: true

  focal_gamma:
    distribution: uniform
    min: 2.0
    max: 3.0

  # LR scheduler
  lr_scheduler:
    values: ['plateau', 'cosine']

  warmup_epochs:
    values: [3, 5]

  plateau_patience:
    value: 5

  plateau_factor:
    value: 0.5

  # Optimizer
  beta1:
    distribution: uniform
    min: 0.90
    max: 0.95

  beta2:
    values: [0.99, 0.998, 0.999]

  # Augmentation
  augmentation:
    values: [true, false]

  oversample_factor:
    values: [1, 2]

  # Gradient accumulation
  accumulation_steps:
    values: [1, 2]
